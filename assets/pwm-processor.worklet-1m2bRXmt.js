(function(){"use strict";class n{static TWO_PI=2*Math.PI;generate(s,t,e){const a=s%n.TWO_PI,r=a,i=(a-2*Math.PI/3+n.TWO_PI)%n.TWO_PI,h=(a-4*Math.PI/3+n.TWO_PI)%n.TWO_PI;return{u:this.calculatePhaseVoltage(r,t,e),v:this.calculatePhaseVoltage(i,t,e),w:this.calculatePhaseVoltage(h,t,e),angle:a}}calculatePhaseVoltage(s,t,e){return e.pulseMode==="Async"?this.compareAsync(s,t,e):this.compareSync(s,e)}compareAsync(s,t,e){const a=e.voltage*Math.sin(s);let r=0;const i=t%n.TWO_PI;return i<Math.PI?r=-1+2/Math.PI*i:r=1-2/Math.PI*(i-Math.PI),a>r?1:-1}compareSync(s,t){let e=1;if(t.pulseMode.startsWith("P")&&(e=parseInt(t.pulseMode.substring(1))),e===1)return Math.sin(s)>0?1:-1;const a=s*e%n.TWO_PI,r=t.voltage*Math.sin(s);let i=0;const h=a;return h<Math.PI?i=-1+2/Math.PI*h:i=1-2/Math.PI*(h-Math.PI),r>i?1:-1}}class I{params;pwmGenerator;time=0;theta=0;carrierTheta=0;constructor(s){this.params={...s},this.pwmGenerator=new n}update(s){this.time+=s;const t=2*Math.PI;this.theta+=t*this.params.freq*s,this.theta%=t,this.carrierTheta+=t*this.params.carrierFreq*s,this.carrierTheta%=t}getOutput(){return this.pwmGenerator.generate(this.theta,this.carrierTheta,this.params)}getTargetOutput(){const s=2*Math.PI,t=this.params.voltage;return{u:t*Math.sin(this.theta),v:t*Math.sin(this.theta-s/3),w:t*Math.sin(this.theta+s/3)}}setParams(s){this.params={...this.params,...s}}getParams(){return{...this.params}}getState(){return{theta:this.theta,carrierTheta:this.carrierTheta}}}class d extends AudioWorkletProcessor{inverter;filterEnabled=!1;lpfU=new l;lpfV=new l;lpfW=new l;constructor(){super();const s={freq:0,voltage:0,phase:0,carrierFreq:1e3,pulseMode:"Async"};this.inverter=new I(s),this.lpfU.setParams(sampleRate,2e3,.707),this.lpfV.setParams(sampleRate,2e3,.707),this.lpfW.setParams(sampleRate,2e3,.707),this.port.onmessage=t=>{if(t.data.type==="updateParams"){const e=t.data.payload;this.inverter.setParams(e)}else if(t.data.type==="setFilter"){const e=t.data.payload;this.filterEnabled=e.enabled;const a=e.cutoff||2e3;this.lpfU.setParams(sampleRate,a,.707),this.lpfV.setParams(sampleRate,a,.707),this.lpfW.setParams(sampleRate,a,.707)}}}process(s,t,e){const a=t[0],r=a[0],i=a[1],h=1/sampleRate;for(let c=0;c<r.length;c++){this.inverter.update(h);const p=this.inverter.getOutput();let u=p.u,o=p.v,P=p.w;this.filterEnabled&&(u=this.lpfU.process(u),o=this.lpfV.process(o),P=this.lpfW.process(P));const g=u-o,M=o-P,f=.1;r[c]=g*f,i&&(i[c]=M*f)}return!0}}class l{b0=0;b1=0;b2=0;a1=0;a2=0;x1=0;x2=0;y1=0;y2=0;setParams(s,t,e){const a=2*Math.PI*t/s,r=Math.sin(a)/(2*e),i=Math.cos(a),h=1+r;this.b0=(1-i)/2/h,this.b1=(1-i)/h,this.b2=(1-i)/2/h,this.a1=-2*i/h,this.a2=(1-r)/h}process(s){const t=this.b0*s+this.b1*this.x1+this.b2*this.x2-this.a1*this.y1-this.a2*this.y2;return this.x2=this.x1,this.x1=s,this.y2=this.y1,this.y1=t,t}}registerProcessor("pwm-processor",d)})();
